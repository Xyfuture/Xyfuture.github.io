<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Bypass Port Isolation (AP Isolation) - Xyfuture's Blog</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Bypass Port Isolation (AP Isolation)"><meta property="og:description" content="UCAS 内网互通 最近有一个简单的需求，我需要在教室访问在宿舍的电脑，windows的rdp成为了最佳选择，但是有一个比较难受的事情是UCAS和sd"><meta property="og:type" content="article"><meta property="og:url" content="http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-14T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-14T00:00:00+00:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bypass Port Isolation (AP Isolation)"><meta name=twitter:description content="UCAS 内网互通 最近有一个简单的需求，我需要在教室访问在宿舍的电脑，windows的rdp成为了最佳选择，但是有一个比较难受的事情是UCAS和sd"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/><link rel=prev href=http://xyfuture.github.io/posts/xmake%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Bypass Port Isolation (AP Isolation)","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/xyfuture.github.io\/posts\/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB\/"},"genre":"posts","wordcount":1630,"url":"http:\/\/xyfuture.github.io\/posts\/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB\/","datePublished":"2022-09-14T00:00:00+00:00","dateModified":"2022-09-14T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"xyfuture"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Xyfuture's Blog">Xyfuture's Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Xyfuture's Blog">Xyfuture's Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Bypass Port Isolation (AP Isolation)</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=about title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>xyfuture</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-09-14>2022-09-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1630 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#总结>总结</a></li></ul><ul><li><a href=#windows下如何修改arp表>windows下如何修改ARP表</a></li><li><a href=#问题>问题</a></li><li><a href=#总结-1>总结</a></li></ul></nav></div></div><div class=content id=content><h1 id=ucas-内网互通>UCAS 内网互通</h1><p>最近有一个简单的需求，我需要在教室访问在宿舍的电脑，windows的rdp成为了最佳选择，但是有一个比较难受的事情是UCAS和sdu一样做了端口隔离和AP隔离，虽然同属一个局域网，但是二层设备限制相互之间的访问。sdu提供了IPV4的公网ip(宿舍网线接口)，因此我们可以通过该ip走3层实现内网之间的互通，ucas没有提供公网ipv4，但是有ipv6的公网ip，不幸的是所有设备的ipv6同属于一个子网，2层都给隔断了，因此也就有了这篇文章，通过多种方式实现内网的互通。</p><h1 id=zerotiertailscale-组网>Zerotier/Tailscale 组网</h1><p>最简单的方式就是使用商业的组网软件了，这两个软件都支持异地组网，在每台设备上虚拟一个网卡，让你无论处于什么网络环境下， 都能通过一个固定的内网地址互相访问。两者都是通过P2P打洞的方式实现多设备的组网。</p><p>即便没有公网IP，zerotier也能通过一定的技术实现NAT打洞，让两个处于NAT状态下的设备直连访问。如果打洞失败，则通过远程的服务器进行转发，不过服务器在国外，效果比较差。在UCAS的网络环境下，打洞是完全没问题的，毕竟设备同处于一个NAT网络下，最简单的情况了，经过测试是在联通的IPv4网络中实现的打洞，多设备互通没问题，延迟有点奇怪，时高时低，最低10ms之下，高的话100ms左右。但是这种方式有一个致命的问题，就是zerotier和tailscale都是通过udp来传输数据，而运营商会进行QoS，速度只有40Mbps，稍微有点慢。</p><h2 id=总结>总结</h2><p>这种方式实现简单，能实现互通，缺点是速度慢，延迟不太稳定。</p><h1 id=使用三层转发>使用三层转发</h1><p>端口隔离和VLAN的原理差不多，就是通过给包打tag的方式实现，进端口加tag，出端口检查tag，tag不对丢弃。如此一下，只允许设备与网关进行通信，与其他端口不允许通信。</p><p>在ipv4的情况下，当我们想访问同一个子网其他设备时，首先使用ARP协议获取其他设备的MAC地址，而加入端口隔离后，我们ARP的广播包只能到网关，其他设备根本收不到，这样我们的电脑根本就不知道另一台设备的MAC，自然就无法通信了。</p><p>明白了这个问题，我们就可以解决了。既然不知道其他设备的MAC，我们手动改写ARP表，直接让设备知道不就行了。有点naive了，因为端口隔离的存在，你的包在二层只能到网关，有了MAC也去不了另一台设备，那么解决方案就只有一个了，让网关(路由器)帮我们转发。此时我们就要卡协议栈的一个bug了，理论上，同属一个网段的两设备通信不需要走网关，但是我们现在希望网关去转发我们的包。下面用一个例子解释。</p><p>设备A ip：10.32.10.32 MAC为 xx-a(48位太长了，简写)</p><p>设备B ip：10.32.10.23 MAC为 xx-b</p><p>网关(路由器) ip：10.32.10.1 MAC为 xx-route</p><p>我们改写设备A的ARP表，让10.32.10.23对应MAC为路由器MAC xx-route，同时改写设备B的ARP表，让10.32.10.32对应MAC也为路由器MAC xx-route。</p><p>此时A向B发包，根据ARP表，MAC填写的是路由器MAC，二层会把包送到路由器，路由器看到包的目的IP为10.32.10.23，不管源IP，直接进行路由，发送到设备B上，B向A发包同理。</p><p>此时，两个设备都仅与网关通信，不受端口隔离影响，借助路由器实现互访，卡了路由器不看源IP的bug。</p><p>以上为ipv4的情况，ipv6情况类似，只不过不用arp协议了，但是还是有一张类似arp表的映射表。</p><h2 id=windows下如何修改arp表>windows下如何修改ARP表</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>netsh interface ipv4 add neighbors <span class=s2>&#34;WLAN&#34;</span> <span class=s2>&#34;IP&#34;</span> <span class=s2>&#34;MAC&#34;</span>
</span></span><span class=line><span class=cl>netsh interface ipv6 add neighbors <span class=s2>&#34;WLAN&#34;</span> <span class=s2>&#34;IP&#34;</span> <span class=s2>&#34;MAC&#34;</span>
</span></span></code></pre></div><p>删除把add换成delete即可</p><h2 id=问题>问题</h2><p>通过路由器转发，速度可到路由器的端口速度，100mbps左右，速度和稳定性都解决了，那么代价是什么呢？</p><p>主要是DHCP下IP会不断的变，需要手动添加删除，比较麻烦，最好的话是开一个服务器，仅供设备分享ip，然后自动添加删除ARP表。</p><h2 id=总结-1>总结</h2><p>绕过2层的隔离，通过3层的路由进行转发，速度快，稳定性好，但是操作麻烦，需要经常修改。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2022-09-14</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/ data-title="Bypass Port Isolation (AP Isolation)"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/ data-title="Bypass Port Isolation (AP Isolation)"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/ data-title="Bypass Port Isolation (AP Isolation)"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=http://xyfuture.github.io/posts/%E7%A0%B4%E8%A7%A3%E7%AB%AF%E5%8F%A3%E9%9A%94%E7%A6%BBap%E9%9A%94%E7%A6%BB/ data-title="Bypass Port Isolation (AP Isolation)"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/xmake%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/ class=prev rel=prev title=xmake基础使用><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>xmake基础使用</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.101.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=about target=_blank>xyfuture</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:100},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:50}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>